package main

// #include <stdlib.h>
import "C"
import (
    "fmt"
    "time"
    "github.com/hidez8891/shm"
)

//export create
func create(tag *C.char, size C.int, data *C.char) {
    str_data := C.GoString(data)
    str_tag := C.GoString(tag)
    int_size := int32(size)

    buf := []byte(str_data)

	m, _ := shm.Create(str_tag, int_size)
    m.Write(buf)
//     defer m.Close()
}

//export get
func get(tag *C.char) *C.char {
    str_tag := C.GoString(tag)

    m, _ := shm.Open(str_tag, 512)
    buf := make([]byte, 512)
    m.Read(buf)
//     defer m.Close()

    return C.CString(string(buf))
}

func main() {
    cgo := C.GoString("\xd4\x00\x04\xc7\x03\x0e\x91\xd4\x05\xc4\x05chess\xc4\x05Board\xde\x00\x11\xc4\x0boccupied_co\xd5\x02\xc7\t\x01\x00\x00\x00\x00\x00\x00\xff\xff\x00\xcd\xff\xff\xc4\x05pawns\xd3\x00\xff\x00\x00\x00\x00\xff\x00\xc4\x07knights\xcfB\x00\x00\x00\x00\x00\x00B\xc4\x07bishops\xcf$\x00\x00\x00\x00\x00\x00$\xc4\x05rooks\xc7\t\x01\x81\x00\x00\x00\x00\x00\x00\x81\x00\xc4\x06queens\xd3\x08\x00\x00\x00\x00\x00\x00\x08\xc4\x05kings\xcf\x10\x00\x00\x00\x00\x00\x00\x10\xc4\x08promoted\x00\xc4\x08occupied\xc7\t\x01\xff\xff\x00\x00\x00\x00\xff\xff\x00\xc4\x08chess960\xc2\xc4\tep_square\xc0\xc4\nmove_stack\xc7\x00\x02\xc4\x06_stack\xc7\x00\x02\xc4\x04turn\xc3\xc4\x0fcastling_rights\xc7\t\x01\x81\x00\x00\x00\x00\x00\x00\x81\x00\xc4\x0ehalfmove_clock\x00\xc4\x0ffullmove_number\x01")
    fmt.Println(cgo)
//     buf := []byte("\xd4\x00\x04\xc7\x03\x0e\x91\xd4\x05\xc4\x05chess\xc4\x05Board\xde\x00\x11\xc4\x0boccupied_co\xd5\x02\xc7\t\x01\x00\x00\x00\x00\x00\x00\xff\xff\x00\xcd\xff\xff\xc4\x05pawns\xd3\x00\xff\x00\x00\x00\x00\xff\x00\xc4\x07knights\xcfB\x00\x00\x00\x00\x00\x00B\xc4\x07bishops\xcf$\x00\x00\x00\x00\x00\x00$\xc4\x05rooks\xc7\t\x01\x81\x00\x00\x00\x00\x00\x00\x81\x00\xc4\x06queens\xd3\x08\x00\x00\x00\x00\x00\x00\x08\xc4\x05kings\xcf\x10\x00\x00\x00\x00\x00\x00\x10\xc4\x08promoted\x00\xc4\x08occupied\xc7\t\x01\xff\xff\x00\x00\x00\x00\xff\xff\x00\xc4\x08chess960\xc2\xc4\tep_square\xc0\xc4\nmove_stack\xc7\x00\x02\xc4\x06_stack\xc7\x00\x02\xc4\x04turn\xc3\xc4\x0fcastling_rights\xc7\t\x01\x81\x00\x00\x00\x00\x00\x00\x81\x00\xc4\x0ehalfmove_clock\x00\xc4\x0ffullmove_number\x01")
//     m, _ := shm.Create("tag", 128)
//     m.Write(buf)
//     defer m.Close()
//
//     t0 := time.Now()
//
//     for i := 0; i < 1; i++ {
//         r, _ := shm.Open("tag", 128)
//         rbuf := make([]byte, 128)
//         r.Read(rbuf)
//         fmt.Println(string(rbuf))
//     }
//
//     t1 := time.Now()
//     fmt.Println(t1.Sub(t0))
}

// func main() {
//     buf := []byte("Ala ma kota!")

// 	m, _ := shm.Create("tag", 128)
//     m.Write(buf)
//     defer m.Close()
//
//     r, _ := shm.Open("tag", 512)
//     rbuf := make([]byte, 512)
//
//     r.Read(rbuf)
//     defer r.Close()

//     fmt.Println(string(rbuf[:]))
// }